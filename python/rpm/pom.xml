<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>

	<artifactId>SlipStreamConnector-FCO-python-rpm</artifactId>
	<name>SlipStream Connector for FCO - Python (RPM)</name>
	<packaging>pom</packaging>

	<parent>
		<groupId>com.sixsq.slipstream</groupId>
		<artifactId>SlipStreamConnector-FCO-python</artifactId>
		<version>0.0.1-SNAPSHOT</version>
	</parent>

	<build>

		<plugins>

			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-dependency-plugin</artifactId>

				<executions>

        <!-- NB! Repackaging of the tarball with tar CLI is a hack to to fix
             an issue with tarball packing by the maven assembly plugin. The
             tarball generated by the maven assembly plugin can't be properly
             extracted by Python 2.7 'tarfile' module.
        -->

					<execution>
						<id>unpack-conector</id>
						<goals>
							<goal>unpack</goal>
						</goals>
						<configuration>
							<artifactItems>
								<artifactItem>
								  <groupId>com.sixsq.slipstream</groupId>
								  <artifactId>SlipStreamConnector-FCO-python-bundle</artifactId>
									<version>${project.version}</version>
									<classifier>bundle</classifier>
									<type>tar.gz</type>
								</artifactItem>
							</artifactItems>
							<stripVersion>true</stripVersion>
                            <outputDirectory>${project.build.directory}/dependency/flexiant</outputDirectory>
						</configuration>
					</execution>

				</executions>

			</plugin>

      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>exec-maven-plugin</artifactId>
        <executions>
          <execution>
            <id>regenerate-tarball</id>
            <phase>package</phase>
            <goals>
              <goal>exec</goal>
            </goals>
            <configuration>
              <executable>tar</executable>
              <arguments>
                <argument>-zcf</argument>
                <argument>${project.build.directory}/flexiantclient.tgz</argument>
                <argument>-C</argument>
                <argument>${project.build.directory}/dependency/flexiant</argument>
                <argument>flexiant</argument>
                <argument>requests</argument>
                <argument>suds</argument>
              </arguments>
            </configuration>
          </execution>
        </executions>
      </plugin>

			<plugin>
				<groupId>org.codehaus.mojo</groupId>
				<artifactId>rpm-maven-plugin</artifactId>
				<extensions>true</extensions>
				<configuration>
					<classifier>${package.os}</classifier>
					<release>${BUILD_NUMBER}.${package.os}</release>
					<summary>SlipStream Connector for FCO - Python</summary>
					<name>slipstream-connector-fco-python</name>
					<group>Applications/Engineering</group>
					<vendor>Flexiant</vendor>
					<packager>Flexiant</packager>
					<copyright>Apache License, Version 2.0</copyright>
					<url>http://www.flexiant.com</url>
					<needarch>noarch</needarch>
					<description>
						SlipStream Connector for FCO - Python.
					</description>
					<requires>
					  <require>python &gt;= 2.6</require>
					  <require>slipstream-client</require>
					  <require>python-suds</require>
                                          <require>python-requests</require>
					</requires>

					<mappings>

						<mapping>
							<directory>/opt/slipstream/downloads</directory>
							<filemode>644</filemode>
							<username>root</username>
							<groupname>root</groupname>
							<directoryIncluded>false</directoryIncluded>
							<sources>
								<source>
									<location>${project.build.directory}/flexiantclient.tgz</location>
                              <includes>
                                <include>/etc/resolv.conf</include>
                              </includes>
								</source>
							</sources>
						</mapping>

                        <mapping>
                          <directory>${slipstream.base.dir}/connectors/bin</directory>
                          <filemode>775</filemode>
                          <username>slipstream</username>
                          <groupname>slipstream</groupname>
                          <directoryIncluded>false</directoryIncluded>
                          <sources>
                            <source>
                              <location>../tar/bin</location>
                              <includes>
                                <include>destroy-vm.py</include>
                                <include>fco-*</include>
                                <include>flex*</include>
                                <include>list_vm.py</include>
                                <!-- include>slipstream.client.conf</include -->
                              </includes>
                            </source>
                          </sources>
                        </mapping>

                        <!-- mapping>
                            <directory>/usr/bin</directory>
                            <sources>
                                <softlinkSource>
                                    <location>${slipstream.base.dir}/connectors/bin/fco-describe-instances</location>
                                </softlinkSource>
                                <softlinkSource>
                                    <location>${slipstream.base.dir}/connectors/bin/fco-run-instances</location>
                                </softlinkSource>
                                <softlinkSource>
                                    <location>${slipstream.base.dir}/connectors/bin/fco-terminate-instances</location>
                                </softlinkSource>
                            </sources>
                        </mapping -->

                        <mapping>
                          <directory>/usr/lib/python2.6/site-packages</directory>
                          <!-- Scripts don't need to be writeable! -->
                          <filemode>555</filemode>
                          <username>slipstream</username>
                          <groupname>slipstream</groupname>
                          <directoryIncluded>false</directoryIncluded>
                          <sources>
                            <source>
                              <location>target/dependency</location>
                              <includes>
                                <include>flexiant/**/*</include>
                                <include>flexiant/packages/*.py</include>
                                <include>flex*</include>
                              </includes>
                              <excludes>
                                <exclude>flexiant/**/*.pyc</exclude>
                              </excludes>
                            </source>
                          </sources>
                        </mapping>

					</mappings>

				</configuration>
				<executions>
					<execution>
						<id>attach-rpm</id>
						<phase>package</phase>
						<goals>
							<goal>attached-rpm</goal>
						</goals>
					</execution>
				</executions>

			</plugin>
		</plugins>

	</build>

</project>
